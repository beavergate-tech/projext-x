# Property Management Database Schema Structure

This document outlines the complete database schema structure for the property management system.

## Directory Structure

```
lib/
└── drizzle/
    ├── index.ts                 # Database connection/config
    ├── seed.ts                  # Seed script for sample data
    └── schema/
        ├── index.ts             # Export all schemas
        ├── nextauth.ts          # Auth tables (users, accounts, sessions, etc.)
        ├── property.ts          # Property management
        ├── landlord.ts          # Landlord profiles
        ├── tenant.ts            # Tenant profiles
        ├── rental.ts            # Rental agreements
        ├── payment.ts           # Rent payments
        └── agreement.ts         # Rent agreement documents

drizzle/                         # Migration files (generated by drizzle-kit)
```

## Schema Overview

### 1. NextAuth Schema (`nextauth.ts`)

**Tables:**
- `user` - User authentication and basic profile
- `account` - OAuth provider accounts
- `session` - Active user sessions
- `verificationToken` - Email verification and magic links

**Enums:**
- `role` - User roles: `LANDLORD`, `TENANT`

**Key Fields:**
- Users have `role`, `phone`, `email`, `password`
- Default role: `TENANT`

---

### 2. Property Schema (`property.ts`)

**Tables:**
- `properties` - Property listings

**Enums:**
- `property_type` - `APARTMENT`, `HOUSE`, `CONDO`, `STUDIO`, `ROOM`
- `property_status` - `AVAILABLE`, `OCCUPIED`, `MAINTENANCE`

**Key Fields:**
- Basic info: name, description, address, city, state, zipCode
- Property details: type, size, bedrooms, bathrooms
- Financial: rentAmount, deposit
- Arrays: images, amenities
- References: landlordId (to LandlordProfile)

---

### 3. Landlord Schema (`landlord.ts`)

**Tables:**
- `landlord_profiles` - Extended landlord information

**Key Fields:**
- userId (references user table)
- businessName
- TODO: More onboarding fields can be added

**Relations:**
- One-to-one with user
- One-to-many with properties

---

### 4. Tenant Schema (`tenant.ts`)

**Tables:**
- `tenant_profiles` - Extended tenant information

**Key Fields:**
- userId (references user table)
- dateOfBirth
- occupation
- assignedPropertyId (references properties)
- rentalId (references rentals when active)

**Relations:**
- One-to-one with user
- Many-to-one with property (assigned)
- Many-to-one with rental (active rental)

---

### 5. Rental Schema (`rental.ts`)

**Tables:**
- `rentals` - Active and historical rental agreements

**Enums:**
- `rental_status` - `ACTIVE`, `EXPIRED`, `TERMINATED`

**Key Fields:**
- propertyId (references properties)
- tenantId (references tenant_profiles)
- startDate, endDate
- monthlyRent, deposit
- status

**Relations:**
- Many-to-one with property
- Many-to-one with tenant
- One-to-many with rent payments
- One-to-many with rent agreements

---

### 6. Payment Schema (`payment.ts`)

**Tables:**
- `rent_payments` - Rent payment tracking

**Enums:**
- `payment_status` - `PENDING`, `PAID`, `OVERDUE`, `CANCELLED`

**Key Fields:**
- rentalId (references rentals)
- amount, lateFee
- dueDate, paidDate
- status
- notes

**Relations:**
- Many-to-one with rental

---

### 7. Agreement Schema (`agreement.ts`)

**Tables:**
- `rent_agreements` - Rental agreement documents

**Enums:**
- `agreement_status` - `DRAFT`, `ACTIVE`, `EXPIRED`, `TERMINATED`

**Key Fields:**
- propertyId (references properties, CASCADE delete)
- rentalId (references rentals, SET NULL on delete)
- templateName, content
- variables, templateVariables (JSON fields)
- rentAmount, securityDeposit
- terms, status
- startDate, endDate
- version

**Relations:**
- Many-to-one with property
- Many-to-one with rental (optional)

---

## Relationships Summary

```
User (LANDLORD)
  └── LandlordProfile
       └── Properties (many)
            ├── RentAgreements (many)
            └── Rentals (many)
                 ├── RentPayments (many)
                 └── RentAgreements (many)

User (TENANT)
  └── TenantProfile
       ├── AssignedProperty (one)
       └── ActiveRental (one)
```

## Key Design Decisions

1. **UUID Primary Keys**: All tables use UUID for primary keys (cuid pattern compatible)

2. **Soft References**: Some foreign keys are not enforced at DB level for flexibility:
   - TenantProfile.assignedPropertyId
   - TenantProfile.rentalId

3. **Cascade Deletes**:
   - User deletion cascades to profiles
   - Property deletion cascades to rent agreements
   - Rental deletion cascades to rent payments

4. **Set Null on Delete**:
   - Rental deletion sets RentAgreement.rentalId to null (preserves historical agreements)

5. **JSON Fields**:
   - RentAgreement uses JSON for flexible template variables

6. **Arrays**:
   - Property images and amenities stored as text arrays

7. **Timestamps**:
   - All tables have createdAt and updatedAt for audit trail

## Database Scripts

```bash
# Generate migrations from schema
bun run db:generate

# Apply migrations to database
bun run db:migrate

# Push schema directly (dev mode)
bun run db:push

# Open Drizzle Studio (visual DB browser)
bun run db:studio

# Seed database with sample data
bun run db:seed
```

## Environment Setup

Required environment variable:
```env
DATABASE_URL="postgresql://user:password@host:5432/database"
```

## Future Enhancements

- [ ] Add maintenance request tracking
- [ ] Add document storage/uploads
- [ ] Add messaging/notifications system
- [ ] Add payment gateway integration
- [ ] Add analytics/reporting tables
- [ ] Add audit log table
- [ ] Add review/rating system
